<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DICOM to STL Converter</title>

    <!-- update the version number as needed -->
    <script defer src="/__/firebase/12.0.0/firebase-app-compat.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/12.0.0/firebase-functions-compat.js"></script>
    <script defer src="/__/firebase/12.0.0/firebase-storage-compat.js"></script>
    <!-- 
      initialize the SDK after all desired features are loaded, set useEmulator to false
      to avoid connecting the SDK to running emulators.
    -->
    <script defer src="/__/firebase/init.js?useEmulator=true"></script>

    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: #f4f7f9;
        color: #333;
        margin: 0;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }
      .container {
        background: white;
        padding: 40px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        text-align: center;
        max-width: 600px;
        width: 100%;
      }
      h1 {
        color: #1a73e8;
        margin-bottom: 20px;
      }
      p {
        color: #5f6368;
        margin-bottom: 30px;
      }
      .upload-area {
        border-radius: 8px;
        padding: 30px 20px;
        margin-bottom: 30px;
        cursor: pointer;
        transition: border-color 0.2s, background-color 0.2s;
      }
      .upload-area:hover {
        border-color: #1a73e8;
        background-color: #f8f9fa;
      }
      .upload-area input[type="file"] {
        display: none;
      }
      .upload-btn {
        background-color: #1a73e8;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.2s;
        width: 100%;
      }
      .upload-btn:disabled {
        background-color: #a0c3ff;
        cursor: not-allowed;
      }
      .upload-btn:not(:disabled):hover {
        background-color: #185abc;
      }
      #status {
        margin-top: 20px;
        font-size: 14px;
        color: #5f6368;
      }
      #file-list {
        text-align: left;
        margin-top: 15px;
        font-size: 14px;
        max-height: 150px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>DICOM to STL Converter</h1>
      <p>DICOMファイル群（フォルダ）を選択し、アップロードして3Dモデルに変換します。</p>
      
      <label for="dicom-files" class="upload-area">
        <div id="upload-prompt">クリックまたはドラッグ＆ドロップで<br>DICOMファイルを選択</div>
        <div id="file-list"></div>
        <input type="file" id="dicom-files" multiple webkitdirectory directory>
      </label>
      
      <button id="upload-button" class="upload-btn" disabled>アップロードして変換開始</button>
      
      <div id="status"></div>
      <div id="result"></div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        try {
          const storage = firebase.storage();
          const functions = firebase.functions();

          const fileInput = document.getElementById('dicom-files');
          const uploadButton = document.getElementById('upload-button');
          const statusDiv = document.getElementById('status');
          const resultDiv = document.getElementById('result');
          const uploadArea = document.querySelector('.upload-area');
          const fileListDiv = document.getElementById('file-list');
          const uploadPrompt = document.getElementById('upload-prompt');

          let selectedFiles = [];

          uploadArea.addEventListener('click', () => fileInput.click());

          uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.style.borderColor = '#1a73e8'; });
          uploadArea.addEventListener('dragleave', (e) => { e.preventDefault(); uploadArea.style.borderColor = '#dadce0'; });
          uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#dadce0';
            if (e.dataTransfer.files.length > 0) handleFiles(e.dataTransfer.files);
          });

          fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFiles(e.target.files);
          });

          function handleFiles(files) {
            selectedFiles = Array.from(files).filter(file => file.name.toLowerCase().endsWith('.dcm') || !file.name.includes('.'));
            if (selectedFiles.length > 0) {
              uploadPrompt.style.display = 'none';
              fileListDiv.innerHTML = `選択されたファイル: ${selectedFiles.length}件<br>` + selectedFiles.map(f => f.name).slice(0, 5).join('<br>') + (selectedFiles.length > 5 ? '<br>...' : '');
              uploadButton.disabled = false;
              statusDiv.textContent = 'アップロードの準備ができました。';
              resultDiv.innerHTML = '';
            } else {
              statusDiv.textContent = 'DICOMファイルが見つかりませんでした。';
            }
          }

          uploadButton.addEventListener('click', async () => {
            if (selectedFiles.length === 0) return;

            uploadButton.disabled = true;
            statusDiv.textContent = 'アップロードを開始します...';

            const uploadId = Date.now().toString() + '-' + Math.random().toString(36).substring(2);

            const totalSize = selectedFiles.reduce((acc, file) => acc + file.size, 0);
            const fileProgress = new Map();

            const uploadPromises = selectedFiles.map(file => {
              const path = file.webkitRelativePath || file.name;
              const filePath = `uploads/${uploadId}/${path}`;
              const uploadTask = storage.ref(filePath).put(file);

              uploadTask.on('state_changed', (snapshot) => {
                fileProgress.set(path, snapshot.bytesTransferred);
                const totalBytesTransferred = Array.from(fileProgress.values()).reduce((acc, val) => acc + val, 0);
                const percent = totalSize > 0 ? Math.round((totalBytesTransferred / totalSize) * 100) : 0;
                statusDiv.textContent = `アップロード中: ${percent}%`;
              });

              return uploadTask;
            });

            try {
              await Promise.all(uploadPromises);
              statusDiv.textContent = 'アップロード完了。STLへの変換を開始します... (バックエンド処理待機中)';
              resultDiv.innerHTML = `処理ID: ${uploadId}`;
            } catch (error) {
              console.error('Upload failed:', error);
              statusDiv.textContent = 'アップロード中にエラーが発生しました。';
              uploadButton.disabled = false;
            }
          });

        } catch (e) {
          console.error(e);
          document.getElementById('status').textContent = 'Firebase SDKの読み込み中にエラーが発生しました。コンソールを確認してください。';
        }
      });
    </script>
  </body>
</html>
